# 実装計画（WebView2 採用版）

この計画は `Document.md`（仕様書、2026-01-16）に基づき、WebView2（Chromium）を縦書きWYSIWYG描画・編集の主担当として採用する前提で再構成したものです。

## スコープ
- 対象: 日本語縦書き脚本制作と A4横向き PDF 出力に対応する Windows デスクトップアプリ。
- 必須: WYSIWYG 縦書きレイアウト、レコード単位編集、PDF 出力、テキスト出力形式、役名色ラベル。
- スコープ外（将来）: 検索/置換、履歴/差分表示、役名辞書の高度な UX。

## M3 までの資産の扱い（残す/捨てる/置き換える）
- 残す:
  - WPF アプリ基盤（起動、メニュー、保存/読込の流れ）
  - データモデル（`DocumentState`, `ScriptRecord`）
  - バージョン付き保存/読込（JSON）
- 置き換える:
  - WPF の縦書き描画 `VerticalDocumentView` → WebView2 内の縦書き描画/編集へ移行
  - 既存のページ枠描画 → Web 側の CSS レイアウトに置換
- 捨てる:
  - WPF の簡易縦書き描画ロジック（列分割・回転描画）

## 先に潰すべきスパイク工程
1. WebView2 の縦書き描画品質確認（`writing-mode: vertical-rl`、游明朝 10.5pt、余白 20/25mm）
2. IME 変換中の編集・キー制御（composition と Enter/Tab/Ctrl+Enter の共存）
3. 手動ページング（keep-together、溢れ警告）の計測方式
4. PDF 出力の一致性（WebView2 印刷結果の固定レイアウト）

## WPF と Web の責務境界
- WPF（単一の正 / Single Source of Truth）
  - ドキュメントモデル（records, pageNumberEnabled, roleDictionary）
  - 保存/読込、ファイル管理
  - コマンド（Open/Save/Export 等）
  - 設定（A4横向き、余白、フォント、行間の固定値）
  - 受信パッチの検証と適用
- WebView2（描画と入力）
  - 縦書き WYSIWYG レイアウト、ページング、役名ラベル表示
  - 文字入力、選択、キャレット移動、キー挙動
  - keep-together と溢れ警告の即時表示
  - PDF 出力のレイアウト生成

## WPF↔Web メッセージ仕様（一覧レベル）
- WPF → Web
  - `initDocument`: 初期ドキュメント（records/設定/ページ番号）
  - `applyPatch`: 部分更新（recordId, field, newText, selection など）
  - `applySettings`: レイアウト設定（余白/フォント/行間/ページ番号）
  - `requestPdf`: PDF 出力要求
- Web → WPF
  - `documentReady`: 初期化完了通知
  - `inputPatch`: 入力差分（recordId, field, newText, selection）
  - `command`: キー由来の操作（Tab/Enter/Ctrl+Enter/Backspace など）
  - `layoutStatus`: 溢れ警告・ページ数・レコード位置情報
  - `exportPdf`: PDF バイナリ or 一時ファイルパス（方式は要選定）

## マイルストーン

### M1. プロジェクト雛形と UI シェル
- WPF アプリの起動、メニュー、基本設定の固定値を保持する。
- WebView2 埋め込みの器を用意する。

受け入れ条件:
- アプリが起動し、WebView2 の空ビューが表示される。
- A4横向き/余白/フォントなどの設定値が WPF 側で保持されている。

### M2. データモデルとドキュメントライフサイクル
- レコードモデルとドキュメント状態を実装する。
- 独自ファイル形式（バージョン付き JSON）で保存/読込できる。
- アプリ設定として表示倍率（ズーム）を保存・復元できる。

受け入れ条件:
- `.vse` を保存/読込できる。
- 読み込んだ内容が WebView2 に渡せる（初期 JSON 送信）。
- 再起動しても前回の表示倍率が復元される。

### M3. WebView2 縦書き描画（表示のみ）
- WebView2 で縦書きレイアウトを表示する。
- A4横向き 固定余白、右→左の列流れ、役名ラベル位置を満たす。

受け入れ条件:
- テスト用 records を送信すると縦書き表示される。
- 余白/フォント/行間が仕様固定値で反映される。

### M3.5. 縦組み字形と縦中横の対応
- 縦中横（数字/英字の横組み）を縦書き内で適切に表示する。
- 句読点や括弧の縦組み字形/位置調整を行う。

受け入れ条件:
- 数字/英字が縦中横として読める見た目になる。
- 句読点/括弧が縦書きとして違和感の少ない位置・字形で表示される。

### M4. WebView2 編集・キー挙動
- レコード内の役名/本文セルの入力を実装する。
- Tab/Shift+Tab/Enter/Ctrl+Enter/Backspace の挙動を仕様通りに実装する。
- IME 変換中は入力を妨げない。
- 表示倍率の表記とズームスライダーを配置する。
- ステータスバーに文字数と倍率を表示する。

受け入れ条件:
- `Document.md` のキー仕様どおりに動作する。
- IME 変換中に入力が破壊されない。
- 表示倍率の変更が UI から行える。
- ステータスバーに文字数と倍率が表示される。

### M5. ページング（keep-together）と溢れ警告
- レコードは改ページで分割しない。
- 1レコードが1ページを超える場合は警告状態を付与。
- ステータスバーに全ページ数と現在ページ位置を表示する。

受け入れ条件:
- 溢れ警告が即時表示され、PDF出力ブロックに利用できる。
- ステータスバーに全ページ数と現在ページ位置が表示される。

### M6. 役名ラベル表示と色付与
- 役名ラベルは先頭列のみ表示し、同名役の色を統合する。
- 役名辞書の簡易 UI を用意する。

受け入れ条件:
- 役名ラベルに背景色が付与され、同名役で一括反映される。

### M7. テキスト出力
- 選択範囲のレコードを `役名「本文」` 形式で出力する。
- 本文内改行は1行に畳む。

受け入れ条件:
- 仕様通りにコピー/書き出しができる。

### M8. PDF 出力と印刷
- WebView2 の印刷を利用して PDF 出力する。
- ページ番号は下中央、ON/OFF 切替可能。
- 溢れ警告が残る場合は出力をブロックする。

受け入れ条件:
- 画面と一致する A4横向き PDF を出力できる。
- 溢れ警告があると出力が止まる。

### M9. 仕様の穴埋め（表示・警告系）
- 本文レコードの溢れ警告の仕様通りの挙動を実装する。
- ページ番号のON/OFF切り替えUIを実装する。

受け入れ条件:
- 溢れ警告の3段階挙動が仕様どおりに動作する。
- ページ番号のON/OFFが画面とPDFに反映される。

### M10. テキスト出力の選択範囲対応
- テキスト出力時の「選択範囲」対応を実装する。

受け入れ条件:
- 選択範囲のレコードのみを出力できる。

### M11. 概要モード
- 概要ページ用の自由入力モードを追加する。
- 段組みなしの縦書き表示とし、複数ページを許容する。
- 溢れ警告と手動改ページを実装する。
- 「編集」内に「概要モード」切り替えを用意する。
- PDF出力時に概要ページを本文の前に追加する。
- 概要データは `.vse` に保存・読込する。

受け入れ条件:
- 概要モードと本文モードを切り替えできる。
- 概要ページを複数ページで表示でき、溢れ警告と手動改ページが機能する。
- PDFに概要ページが先頭で出力される。
- 概要を保存・読込できる。

### M12. 簡易モード
- 横書き1列でページなしの編集画面を追加する。
- 役名セルと本文セルを横並びで表示する。
- 「編集」内に「簡易モード」切り替えを追加する。
- 簡易モードでも「選択モード」のON/OFFができる。
- 簡易モードの編集内容は本文モードと共通で反映される。
- 役名セルの横幅は「役名セル上限文字数」を横幅として扱う。

受け入れ条件:
- 簡易モードで横書き2列表示と編集ができる。
- 簡易モードの変更が本文モードに反映される。
- 選択モードのON/OFFが動作する。

### M13. 品質と配布
- レイアウト規則、シリアライズ、キー操作の基本テスト。
- Windows 向けインストーラまたはポータブル配布。

受け入れ条件:
- リリース可能なビルドが生成できる。

## 性能対策を入れるタイミング
- M3: 表示のみでも、初期描画が遅い場合は DOM 仮想化を検討
- M4: 入力処理に debounce / patch バッチングを導入
- M5: レイアウト再計算は「編集されたレコードのみ」再計測＋キャッシュ
- M8: PDF 出力の生成負荷が高い場合は進捗表示とタイムアウト対策

## 早期に確定すべきリスクと判断
- WebView2 の縦書き描画精度と PDF 出力の一致性
- IME とキー制御の両立
- Web 側ページング計測の精度と性能

## テスト計画（最小）
- レイアウト: レコード間隔、役名ラベル位置、改ページ keep-together。
- 入力: キー移動規則とレコード削除挙動。
- 出力: テキスト/PDF が要件と一致すること。
